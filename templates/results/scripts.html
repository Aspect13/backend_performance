{% set source_data = test_data['test_config'].get('source', {}) %}

<script src="{{ url_for('design-system.static', filename='assets/js/dropdowns.js') }}"></script>
<script src="{{ url_for('design-system.static', filename='assets/vendor/nouislider/nouislider.js') }}"></script>
<script src="{{ url_for('design-system.static', filename='assets/vendor/nouislider/wNumb.min.js') }}"></script>
<script src="{{ url_for('backend_performance.static', filename='js/performanceBackend.js') }}"></script>
<script src="{{ url_for('backend_performance.static', filename='js/components/AnalyticFilterDropdown.js') }}"></script>
<script src="{{ url_for('backend_performance.static', filename='js/components/AnalyticFilterBlock.js') }}"></script>
<script src="{{ url_for('backend_performance.static', filename='js/components/AnalyticFilter.js') }}"></script>
<script src="https://unpkg.com/bootstrap-table@1.15.5/dist/bootstrap-table.min.js"></script>
<script src="{{ url_for('backend_performance.static', filename='js/logs_updater.js') }}"></script>
<script src="{{ url_for('backend_performance.static', filename='js/in_progress.js') }}"></script>
<script src="{{ url_for('backend_performance.static', filename='js/artifacts.js') }}"></script>
<script>
    var analyticsLine;
    let low_value = 0;
    let high_value = 100;
    $(document).on('vue_init', function() {

        async function getTestStatus() {
            const projectId = {{ test_data.project_id }}
            const testId = {{ test_data.id }}
            const response = await fetch(`/api/v1/backend_performance/reports/${projectId}/?report_id=${testId}`)
            const {test_status: { percentage }} = await response.json();
            checkTestStatus(percentage)
        }
        function checkTestStatus(percentage) {
            if(percentage === 100) {
                $('#AN').removeClass('disabled');
                $('#analytic-loader').hide()
            } else {
                $('#AN').addClass('disabled')
                $('#analytic-loader').show()
                setTimeout(getTestStatus, 5000)
            }
        }


        getTestStatus()
        setParams();
        loadRequestData('/api/v1/backend_performance/charts/requests/summary', "Response time, ms");
        fillErrorTable();
        fillSummaryTable();
        if ($("#vuh-perfomance-time-picker").length > 0){
            const perfomanceTimePicker = noUiSlider.create($("#vuh-perfomance-time-picker")[0], {
            range: {
                'min': 0,
                'max': 100
            },
            start: [low_value, high_value],
            connect: true,
            format: wNumb({
                decimals: 0
            }),
        })
        perfomanceTimePicker.on('set', function(values) {
            low_value = values[0]
            high_value = values[1]
            resizeChart();
        });
        }

    });
</script>


<script src="{{ url_for('backend_performance.static', filename='js/results.js') }}"></script>
{{ template_slot('params_table_scripts') | safe }}
{{ template_slot('sources_scripts') | safe }}
{{ template_slot('locations_scripts') | safe }}
{{ template_slot('integrations_backend_performance_scripts') | safe }}
<script src="{{ url_for('backend_performance.static', filename='js/quality_gate.js') }}"></script>
<script>
    $(document).on('vue_init', () => {
        const nav_links = $('#source_card_config a')
        nav_links.removeClass('disabled')
        SourceCard.Manager('source_card_config').set({{ source_data | default({}) | tojson }})
        nav_links.addClass('disabled')
        IntegrationSection.Manager().set({{ integrations_data | default({}) | tojson }})
    })
</script>

<script>
    function fillErrorTable() {
        var start_time = $("#start_time").html()
        var end_time = $("#end_time").html()
        test_name = '{{ test_data['name'] }}';
        $('#errors').bootstrapTable('refreshOptions', {
            url: `/api/v1/backend_performance/charts/errors/table?test_name=${test_name}&start_time=${start_time}&end_time=${end_time}&low_value=${low_value}&high_value=${high_value}`
        })
    }
    function setParams() {
        build_id = '{{ test_data['build_id'] }}';
        testId = '{{ test_data['id'] }}';
        lg_type = '{{ test_data['lg_type'] }}';
        test_name = '{{ test_data['name'] }}';
        environment = '{{ test_data['environment'] }}';
        samplerType = $("#sampler").val()?.toUpperCase();
        statusType = $("#status").val()?.toLowerCase();
        aggregator = $("#aggregator").val()?.toLowerCase();
    }
</script>